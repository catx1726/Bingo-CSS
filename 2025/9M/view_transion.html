<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ViewTransition</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet" />
    <style>
      * {
        margin: 0;
        padding: 0;
        transition: all 0.3s ease;
        box-sizing: border-box;
      }

      .custom-container {
        width: 100%;
        height: 100vh;
      }

      .box {
        cursor: pointer;
        height: 300px;
        width: 200px;
        border-radius: 4px;
      }

      /* 随机给 box 添加 background image */
      .box:nth-child(1) {
        background-image: url('https://images.pexels.com/photos/9407824/pexels-photo-9407824.jpeg');
      }
      .box:nth-child(2) {
        background-image: url('https://images.pexels.com/photos/5874965/pexels-photo-5874965.jpeg');
      }
      .box:nth-child(3) {
        background-image: url('https://images.pexels.com/photos/6415077/pexels-photo-6415077.jpeg');
      }
      .box:nth-child(4) {
        background-image: url('https://images.pexels.com/photos/27835917/pexels-photo-27835917.jpeg');
      }
      .box:nth-child(5) {
        background-image: url('https://images.pexels.com/photos/23132306/pexels-photo-23132306.jpeg');
      }
      .box:nth-child(6) {
        background-image: url('https://images.pexels.com/photos/14377436/pexels-photo-14377436.jpeg');
      }
      .box:nth-child(7) {
        background-image: url('https://images.pexels.com/photos/15215349/pexels-photo-15215349.jpeg');
      }
      .box:nth-child(8) {
        background-image: url('https://images.pexels.com/photos/8173839/pexels-photo-8173839.jpeg');
      }

      .detail-box,
      .cover,
      .box {
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }

      .modal {
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        position: fixed;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease-in-out, background-color 0.5s ease-in-out;
      }

      .modal.is-active {
        opacity: 1;
        pointer-events: auto;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .detail-box {
        position: fixed;
        height: 300px;
        width: 200px;
        border-radius: 4px;
        /* 使用 CSS 变量来设置初始位置，但不要在 transform 中使用 */
        left: var(--x, 50%);
        top: var(--y, 50%);
        transform: translate(-50%, -50%); /* 确保元素中心点对齐 */
        opacity: 0;

        transform-origin: center;
        transition: all 0.3s ease;
      }

      .detail-box.is-open {
        left: 50%;
        top: 50%;
        width: 50vw;
        height: 50vh;
        opacity: 1;
        border-radius: 4px;
        transform: translate(-50%, -50%);
      }

      .content {
        border-radius: 0 4px 4px 0;
      }

      .cover {
        border-radius: 4px 0 0 4px;
      }

      .detail-box .cover {
        height: 100%;
        width: 100%;
      }

      .detail-box .content {
        /* 关键修改：使用 max-width 来控制占位 */
        max-width: 0;
        opacity: 0;
        visibility: hidden;
        transform: scaleX(0);
        overflow: hidden;

        transition-delay: 0s;
        background-color: white;
        transform-origin: top left;
      }

      .detail-box.is-open > .content {
        padding: 12px;

        opacity: 1;
        /* 展开后的宽度 */
        max-width: 20vw;
        visibility: visible;
        transform: scaleY(1);
      }

      .detail-box.is-closing > .content {
        padding: 0;

        opacity: 0;
        max-width: 0;
        visibility: hidden;
        overflow: hidden;
        transform: scaleX(0);
      }

      .detail-box.is-animating {
        animation: open-modal 0.5s ease-in-out forwards;
      }

      .detail-box.is-closing {
        animation: close-modal 0.5s ease-in-out forwards;
      }

      /* 打开动画 */
      @keyframes open-modal {
        0% {
          /* 初始状态：只改变 scale 和 opacity，位置由 left/top 决定 */
          left: var(--x);
          top: var(--y);
          transform: translate(-50%, -50%) scale(0);
          opacity: 0;
        }
        50% {
          /* 中间状态：展开到完整尺寸，位置不变，圆形 */
          transform: translate(-50%, -50%) scale(1);
          opacity: 1;
        }
        100% {
          /* 最终状态：移动到视窗中心，尺寸不变，变为方形 */
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%) scale(1);
          opacity: 1;
        }
      }

      /* 关闭动画 */
      @keyframes close-modal {
        0% {
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%) scale(1);
          border-radius: 4px;
          opacity: 1;
        }
        50% {
          /* 中间状态：从中心回退到点击位置，尺寸不变，变为圆形 */
          left: var(--x);
          top: var(--y);
          height: 300px;
          width: 200px;
          transform: translate(-50%, -50%) scale(1);
          opacity: 1;
        }
        100% {
          /* 最终状态：收缩到零尺寸 */
          left: var(--x);
          top: var(--y);
          height: 300px;
          width: 200px;
          transform: translate(-50%, -50%);
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <main class="custom-container flex flex-wrap justify-around items-center">
      <section class="box">
        <!-- 随机内容 -->
        <p class="text-white text-xl opacity-0 hidden">Lorem ipsum dolor sit, amet consectetur adipisicing elit.</p>
      </section>
      <section class="box">
        <!-- 随机内容，但要和其他元素区分开 -->
        <p class="text-white text-xl opacity-0 hidden">
          Lorem ipsum, dolor sit amet consectetur adipisicing elit. Molestiae earum reiciendis fugit in officiis, quos aliquam, qui adipisci eaque nobis
          similique.
        </p>
      </section>
      <section class="box">
        <!-- 随机内容，但要和其他元素区分开 -->
        <p class="text-white text-xl opacity-0 hidden">
          Lorem ipsum dolor sit amet, consectetur adipisicing elit. Obcaecati doloribus blanditiis velit iste. Itaque dignissimos rerum illo ea eius!
          Consequuntur distinctio impedit, neque fugit magnam vel rerum facilis a nam?
        </p>
      </section>
      <section class="box">
        <!-- 随机内容，但要和其他元素区分开 -->
        <p class="text-white text-xl opacity-0 hidden">
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Voluptatibus ratione nisi iure sunt sed quo. Dignissimos deleniti, eos numquam distinctio
          tenetur nobis suscipit asperiores neque totam autem ipsum expedita aliquam.
        </p>
      </section>
      <section class="box">
        <!-- 随机内容，但要和其他元素区分开 -->
        <p class="text-white text-xl opacity-0 hidden">
          Lorem ipsum dolor sit amet consectetur, adipisicing elit. Pariatur alias numquam repellat, iure error obcaecati impedit optio nulla nemo reprehenderit
          repudiandae veritatis quidem fuga beatae magnam! Vel iusto est iure?
        </p>
      </section>
      <section class="box">
        <p class="text-white text-xl opacity-0 hidden">
          Lorem ipsum dolor sit amet, consectetur adipisicing elit. Sint saepe incidunt ex aspernatur consequatur! Error, eum. Ipsum eum mollitia explicabo hic,
          ea dignissimos perferendis iusto sint, voluptatibus quam voluptates repellendus?
        </p>
      </section>
      <section class="box">
        <p class="text-white text-xl opacity-0 hidden">
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Quas soluta inventore esse et. Impedit, incidunt? Nostrum illo officiis velit nulla obcaecati
          deserunt culpa quidem! Cupiditate voluptas soluta quod laudantium et?
        </p>
      </section>
      <section class="box">
        <p class="text-white text-xl opacity-0 hidden">
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Quas soluta inventore esse et. Impedit, incidunt? Nostrum illo officiis velit nulla obcaecati
          deserunt culpa quidem! Cupiditate voluptas soluta quod laudantium et?
        </p>
      </section>
    </main>

    <main class="modal">
      <div class="detail-box flex">
        <div class="cover"></div>
        <div class="content">
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Molestias incidunt hic molestiae doloremque dolores laudantium laboriosam reiciendis deserunt
          quod consequatur necessitatibus ex, in voluptatum sit, blanditiis voluptas unde officiis rem.
        </div>
      </div>
    </main>
  </body>
  <script>
    const detailBox = document.querySelector('.detail-box')
    const modal = document.querySelector('.modal')

    // 使用变量存储点击位置，以便在关闭时使用
    let lastClickPos = { x: 0, y: 0 }

    function getClickEleCenterPos(event) {
      const rect = event.target.getBoundingClientRect()
      return {
        x: rect.left + rect.width / 2,
        y: rect.top + rect.height / 2
      }
    }

    function handleClickEle(event) {
      const { x, y } = getClickEleCenterPos(event)
      lastClickPos = { x: `${x}px`, y: `${y}px` }

      copyInfoToDetailBox(event)

      openAnimation()
    }

    function copyInfoToDetailBox(e) {
      // 复制点击元素的内容（文本、图片、所有样式）到 detailBox

      detailBox.children[0].style.backgroundImage = getComputedStyle(e.target).backgroundImage
      // 解决display:none 会拿不到 innerHtml,并且有可能为空
      if (e.target.querySelector('p')) detailBox.children[1].innerHTML = e.target.querySelector('p')?.innerHTML

      // detailBox.children[1].innerHTML += event.target.innerHTML
    }

    function openAnimation() {
      // 1. 设置 CSS 变量来定位 detail-box 的初始位置
      detailBox.style.setProperty('--x', lastClickPos.x)
      detailBox.style.setProperty('--y', lastClickPos.y)

      // 2. 移除关闭动画类，避免冲突
      detailBox.classList.remove('is-closing')

      // 3. 激活 modal 和 detail-box 的动画类
      modal.classList.add('is-active')
      detailBox.classList.add('is-animating')

      // 4. 动画结束后，移除 is-animating 类，并保持最终状态
      detailBox.addEventListener(
        'animationend',
        function handler() {
          detailBox.removeEventListener('animationend', handler)
          detailBox.classList.remove('is-animating')
          detailBox.classList.add('is-open')
        },
        { once: true }
      )
    }

    function closeAnimation() {
      // 1. 设置 CSS 变量，用于关闭动画
      detailBox.style.setProperty('--x', lastClickPos.x)
      detailBox.style.setProperty('--y', lastClickPos.y)

      // 2. 启动关闭动画
      detailBox.classList.add('is-closing')

      // 3. 监听关闭动画结束
      detailBox.addEventListener(
        'animationend',
        function handler() {
          detailBox.removeEventListener('animationend', handler)
          detailBox.classList.remove('is-closing')
          detailBox.classList.remove('is-open')
          modal.classList.remove('is-active')
        },
        { once: true }
      )
    }

    function init() {
      const boxs = document.querySelectorAll('.box')
      boxs.forEach((box) => {
        box.addEventListener('click', handleClickEle)
      })

      modal.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          closeAnimation()
        }
      })
    }

    window.onload = function () {
      init()
    }
  </script>
</html>
